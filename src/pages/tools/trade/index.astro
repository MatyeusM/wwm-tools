---
import Layout from '@/layouts/Layout.astro'
import Header from '@/components/generic/Header.astro'

export const meta = {
  icon: 'fa6-solid:coins',
  title: 'Tradehall Calculator',
  description:
    'Optimize your guild techniques, and compare prices between selling to guild mates vs. selling to non-guild members or yourself.',
  type: 'tool',
  linkText: 'Calculate',
  createdDate: '2026-02-11',
  updatedDate: '2026-02-11',
  draft: false,
}
---

<Layout>
  <div class="trade-tool">
    <Header
      title="Tradehall Calculator"
      description="Optimize your guild techniques and compare trade profits."
      variant="large"
    />

    <div class="trade-controls card">
      <div class="control-group">
        <label for="bonus-level">Selling Bonus Rank (0-20)</label>
        <input type="number" id="bonus-level" min="0" max="20" step="1" value="0" />
        <label for="tax-level">Market Tax Reduction Rank (0-20)</label>
        <input type="number" id="tax-level" min="0" max="20" step="1" value="0" />
      </div>
      <div class="control-group optimizer-form">
        <label for="wonder-jades">Available Wonder Jades</label>
        <input type="number" id="wonder-jades" min="0" value="0" step="50" />
        <button id="optimize-btn" class="primary">Optimize</button>
      </div>
    </div>

    <div class="table-container card">
      <table id="results-table">
        <thead>
          <tr>
            <th title="Base sales percentage shown in the game market.">Sales %</th>
            <th>Actual Profit (NG)</th>
            <th id="shifting-header-btn" class="clickable-header">
              <span id="header-text">Equivalent Guild %</span>
              <span class="icon">â‡„</span>
            </th>
            <th id="guild-profit-header">Guild Sale Profit</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>

    <div id="optimizer-overlay" class="overlay hidden">
      <div class="overlay-content card">
        <h2>Optimization Results</h2>
        <div id="optimizer-results-text"></div>
        <div class="overlay-actions">
          <button id="apply-optimize" class="primary">Apply Levels</button>
          <button id="close-overlay">Close</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { StateManager } from '@/lib/state-manager'
  import { updateTable, type TableElements } from './render-table'
  import { optimizeWealth, calculateFactor } from './optimizer'

  const initialState = new Map<string, any>([
    ['taxLevel', 0],
    ['saleBonusRank', 0],
    ['flexMode', true], // true: NG_TO_GUILD, false: GUILD_TO_NG
  ])

  const state = new StateManager(initialState, 'trade-state')

  // DOM Elements
  const taxInput = document.getElementById('tax-level') as HTMLInputElement
  const bonusInput = document.getElementById('bonus-level') as HTMLInputElement
  const jadeInput = document.getElementById('wonder-jades') as HTMLInputElement
  const optimizeBtn = document.getElementById('optimize-btn')
  const tableElements: TableElements = {
    tableBody: document.querySelector('#results-table tbody')!,
    shiftingHeaderBtn: document.getElementById('shifting-header-btn')!,
    headerText: document.getElementById('header-text')!,
    guildProfitHeader: document.getElementById('guild-profit-header')!,
  }
  const overlay = document.getElementById('optimizer-overlay')!
  const overlayText = document.getElementById('optimizer-results-text')!
  const closeOverlay = document.getElementById('close-overlay')!
  const applyOptimize = document.getElementById('apply-optimize')!

  let pendingOptimization: any = null

  // Initialize inputs from state
  taxInput.value = state.get('taxLevel')
  bonusInput.value = state.get('saleBonusRank')

  // Event Listeners
  taxInput.oninput = () => state.set('taxLevel', parseInt(taxInput.value) || 0)
  bonusInput.oninput = () => state.set('saleBonusRank', parseInt(bonusInput.value) || 0)

  tableElements.shiftingHeaderBtn.onclick = () => {
    state.set('flexMode', !state.get('flexMode'))
  }

  optimizeBtn!.onclick = () => {
    const startTax = state.get('taxLevel')
    const startBonus = state.get('saleBonusRank')
    const jades = parseInt(jadeInput.value) || 0
    const result = optimizeWealth(jades, startTax, startBonus)

    if (result.usedJades === 0) return

    pendingOptimization = result

    const currentFactor = result.profitFactor
    const oldFactor = calculateFactor(startTax, startBonus)
    const gainPercentage = ((currentFactor - oldFactor) / oldFactor) * 100

    overlayText.innerHTML = `
      <p>By spending <strong>${result.usedJades}</strong> Wonder Jades, you can reach:</p>
      <ul>
        <li>Selling Bonus: Rank <strong>${result.bestBonusLevel}</strong></li>
        <li>Market Tax Reduction: Rank <strong>${result.bestTaxLevel}</strong></li>
      </ul>
      <p>Total Profit Increase: <strong>+${gainPercentage.toFixed(2)}%</strong></p>
      <p><small>(Profit Factor: ${(currentFactor * 100).toFixed(2)}%)</small></p>
    `
    overlay.classList.remove('hidden')
  }

  closeOverlay.onclick = () => overlay.classList.add('hidden')
  applyOptimize.onclick = () => {
    if (pendingOptimization) {
      state.set('taxLevel', pendingOptimization.bestTaxLevel)
      state.set('saleBonusRank', pendingOptimization.bestBonusLevel)
      taxInput.value = pendingOptimization.bestTaxLevel
      bonusInput.value = pendingOptimization.bestBonusLevel
    }
    overlay.classList.add('hidden')
  }

  // State Subscription
  state.subscribe(s => {
    updateTable(s, tableElements)
  })

  // Initial call
  updateTable(state.getState(), tableElements)
</script>

<style lang="scss">
  @use '@/scss/mixins' as *;

  .trade-tool {
    padding: 1rem;
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .card {
    @include background(surface-1);
    @include border($top: true, $bottom: true);
    @include shadow-elevation(lg);
    display: flex;
    padding: 1.5rem 1.5rem 1.125rem 1.5rem;
  }

  .trade-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.75rem;
    align-items: stretch;
    padding: 0;

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 1.5rem 1.5rem;

      label {
        @include font-size(sm);
        @include text-color(muted);
        @include increase-letter-spacing(0.5);
      }

      input {
        height: 2.25rem;
        padding: 0 0.75rem;
        @include background(surface-2);
        @include border;
        @include text-color(default);

        &:not(:last-child) {
          margin-bottom: 1rem;
        }

        &:focus {
          @include border($color: primary);
          box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);
          outline: none;
        }
      }
    }

    .optimizer-form {
      position: relative;
      padding-left: 1rem;

      button {
        margin-top: auto;
      }

      &::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0.25rem;
        bottom: 0.25rem;
        width: 1px;
        @include background(surface-3);
      }
    }
  }

  .table-container {
    overflow-x: auto;
    .clickable-header {
      user-select: none;
      @include hover-transition($color: get-text-color(default));

      .icon {
        @include font-size(sm);
        margin-left: 0.3rem;
      }
    }
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    @include background(surface-0, 0.8, sm);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;

    &.hidden {
      display: none;
    }

    .overlay-content {
      max-width: 400px;
      width: 90%;
      @include border($all: true);
      flex-direction: column;

      :global(h2) {
        margin-bottom: 1rem;
      }
      :global(ul) {
        margin: 1rem 0;
        padding-left: 1.5rem;
      }
      .overlay-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }
    }
  }
</style>
