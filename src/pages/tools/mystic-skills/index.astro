---
import Layout from '@/layouts/layout.astro'
import Header from '@/components/generic/header.astro'
import Card from '@/components/generic/card.astro'
import { WEEKLY_CHESTS, MATS_PER_CHEST, SKILL_ORDER } from '@/lib/wwm-constants'

export const meta = {
  icon: 'fa6-solid:scroll',
  title: 'Mystic Skill Tracker',
  description: 'Track and plan your Mystic Skill progression across all tiers.',
  type: 'tool',
  linkText: 'Track',
  createdDate: '2026-02-13',
  updatedDate: '2026-02-13',
  draft: false,
}

// Load and Preprocess Data
const skillFiles = import.meta.glob('/src/wwm-data/mystic-skills/*.yaml', { eager: true });

interface SkillData {
  name: string;
  category: string;
  tiers: {
    has_tiers: boolean;
    starting_tier: number;
    starting_rank: number;
    rank_ups: Array<{
      tier: number;
      ranks: Array<{
        rank: number;
        cost: Array<{
          item: string;
          amount: number;
        }>;
      }>;
    }>;
  };
}

const skillsRaw = Object.values(skillFiles)
  .map((m: any) => m.default as SkillData)
  .filter(s => s.tiers?.has_tiers)
  .map(s => {
    // Simplify Ebon Iron names
    const processedTiers = {
      ...s.tiers,
      rank_ups: s.tiers.rank_ups.map(tu => ({
        ...tu,
        ranks: tu.ranks.map(r => ({
          ...r,
          cost: r.cost.map(c => ({
            ...c,
            item: c.item.replace(/Lv\.\s\d+\sEbon Iron/, 'Ebon Iron')
          }))
        }))
      }))
    };
    return { ...s, tiers: processedTiers };
  });

// Flat list for initials
const skillsFlat = [...skillsRaw];

const skillInitials = skillsFlat.map(s => ({
  id: s.name.toLowerCase().replace(/\s+/g, '-'),
  name: s.name,
  minTier: s.tiers.starting_tier,
  maxTier: Math.max(...s.tiers.rank_ups.map(tu => tu.tier)),
  ranksPerTier: s.tiers.rank_ups.reduce((acc, tu) => {
    acc[tu.tier] = tu.ranks.length - 1;
    return acc;
  }, {} as Record<number, number>)
}));

---

<Layout title={meta.title} description={meta.description}>
  <div class="mystic-tracker">
    <Header
      title={meta.title}
      description="Track and plan your Mystic Skill progression across all tiers."
    />

    <div class="tracker-layout">
      <section class="summary-panel">
        <Card class="summary-group"  border="none">
          <label class="group-label">Total Materials</label>
          <div id="total-costs" class="costs-grid">
            <!-- Populated by JS -->
          </div>
        </Card>

        <Card class="summary-group" border="none">
          <label class="group-label">Time Estimation</label>
          <div id="time-metrics" class="metrics-grid">
            <!-- Populated by JS -->
          </div>
        </Card>

        <Card class="summary-group" border="none">
          <label class="group-label">Efficiency</label>
          <div id="efficiency-metrics" class="metrics-grid">
            <!-- Populated by JS -->
          </div>
        </Card>

        <Card class="summary-group settings-group"  border="none">
          <label class="group-label">Settings</label>
          <div class="settings-content">
            <label class="checkbox-container">
              <input type="checkbox" id="gather-mode" checked />
              <span class="checkmark"></span>
              Include Daily Gathering
            </label>
            <div class="info-footer">
              <p><small>Weekly Chests: {WEEKLY_CHESTS} &times; {MATS_PER_CHEST} mats</small></p>
            </div>
          </div>
        </Card>
      </section>

      <div class="blocks-container">
        {SKILL_ORDER.map((block, blockIdx) => {
          const blockSkills = block.map(name => skillsRaw.find(s => s.name === name)).filter(Boolean) as SkillData[];
          if (blockSkills.length === 0) return null;

          return (
            <section class="skill-block">
              <div class="skills-grid">
                {blockSkills.map(skill => {
                  const id = skill.name.toLowerCase().replace(/\s+/g, '-');
                  const maxTier = Math.max(...skill.tiers.rank_ups.map(tu => tu.tier));
                  
                  return (
                    <Card class="skill-entry" data-skill-name={skill.name}>
                      <div class="skill-info">
                        <h4>{skill.name}</h4>
                      </div>
                      
                      <div class="skill-content">
                        <div class="upgrade-table">
                          <div class="table-header">
                            <span></span>
                            <span class="col-label">Tier</span>
                            <span class="col-label">Rank</span>
                          </div>
                          <div class="table-row">
                            <span class="row-label">Current</span>
                            <input type="number" class="cur-tier" data-id={id} min={skill.tiers.starting_tier} max={maxTier} value={skill.tiers.starting_tier} />
                            <input type="number" class="cur-rank" data-id={id} min="0" value="0" />
                          </div>
                          <div class="table-row">
                            <span class="row-label">Target</span>
                            <input type="number" class="target-tier" data-id={id} min={skill.tiers.starting_tier} max={maxTier} value={skill.tiers.starting_tier} />
                            <input type="number" class="target-rank" data-id={id} min="0" value="0" />
                          </div>
                        </div>

                        <div class="skill-costs-mini" data-skill-id={skill.name}>
                          <!-- Populated by JS -->
                        </div>
                      </div>
                    </Card>
                  );
                })}
              </div>
            </section>
          );
        })}
      </div>
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ skillsInitialData: skillInitials, fullSkillsData: skillsRaw }}>
  window.MYSTIC_SKILLS_DATA = fullSkillsData;
  window.MYSTIC_SKILLS_INITIALS = skillsInitialData;
</script>

<script>
  import { StateManager } from '@/lib/state-manager'
  import { calculateTotals, getAcquisitionPlan, sortMaterials } from './logic'

  const skills = (window as any).MYSTIC_SKILLS_DATA;
  const skillsInitials = (window as any).MYSTIC_SKILLS_INITIALS;

  const initialValues = new Map<string, any>();
  initialValues.set('gatherMode', true);
  
  skillsInitials.forEach((s: any) => {
    initialValues.set(`${s.id}-curTier`, s.minTier);
    initialValues.set(`${s.id}-curRank`, 0);
    initialValues.set(`${s.id}-targetTier`, s.minTier);
    initialValues.set(`${s.id}-targetRank`, 0);
  });

  const state = new StateManager(initialValues, 'mystic-skills-state');

  const gatherCheckbox = document.querySelector('#gather-mode') as HTMLInputElement;
  const totalCostsEl = document.querySelector('#total-costs')!;
  const timeMetricsEl = document.querySelector('#time-metrics')!;
  const efficiencyMetricsEl = document.querySelector('#efficiency-metrics')!;

  const curTierInputs = document.querySelectorAll('.cur-tier') as NodeListOf<HTMLInputElement>;
  const curRankInputs = document.querySelectorAll('.cur-rank') as NodeListOf<HTMLInputElement>;
  const targetTierInputs = document.querySelectorAll('.target-tier') as NodeListOf<HTMLInputElement>;
  const targetRankInputs = document.querySelectorAll('.target-rank') as NodeListOf<HTMLInputElement>;

  const updateInputsFromState = () => {
    gatherCheckbox.checked = state.get('gatherMode') as boolean;
    
    const setInputValue = (inputs: NodeListOf<HTMLInputElement>, suffix: string) => {
      inputs.forEach(input => {
        const id = input.dataset.id!;
        const val = state.get<number | string | boolean>(`${id}-${suffix}`);
        input.value = val !== undefined ? val.toString() : '';
        
        if (suffix.includes('Tier')) {
          const tier = parseInt(input.value);
          const skill = skillsInitials.find((si: any) => si.id === id);
          if (!skill) return;
          const maxRank = skill.ranksPerTier[tier] || 0;
          const rankInputSelector = suffix.startsWith('cur') ? `.cur-rank[data-id="${id}"]` : `.target-rank[data-id="${id}"]`;
          const rankInput = document.querySelector(rankInputSelector) as HTMLInputElement;
          if (rankInput) {
            rankInput.max = maxRank.toString();
            if (parseInt(rankInput.value) > maxRank) {
              rankInput.value = maxRank.toString();
              state.set(`${id}-${suffix.replace('Tier', 'Rank')}`, maxRank);
            }
          }
        }
      });
    };

    setInputValue(curTierInputs, 'curTier');
    setInputValue(curRankInputs, 'curRank');
    setInputValue(targetTierInputs, 'targetTier');
    setInputValue(targetRankInputs, 'targetRank');
  };

  gatherCheckbox.addEventListener('change', () => state.set('gatherMode', gatherCheckbox.checked));

  const addInputListener = (inputs: NodeListOf<HTMLInputElement>, suffix: string) => {
    inputs.forEach(input => {
      input.addEventListener('change', () => {
        const id = input.dataset.id!;
        let val = parseInt(input.value) || 0;
        const min = parseInt(input.min) || 0;
        const max = parseInt(input.max) || 999;
        if (val < min) val = min;
        if (val > max) val = max;
        input.value = val.toString();
        state.set(`${id}-${suffix}`, val);
        updateInputsFromState();
      });
    });
  };

  addInputListener(curTierInputs, 'curTier');
  addInputListener(curRankInputs, 'curRank');
  addInputListener(targetTierInputs, 'targetTier');
  addInputListener(targetRankInputs, 'targetRank');

  const updateUI = () => {
    const { skillTotals, globalTotals } = calculateTotals(skills, state.getState());
    const gatherMode = state.get('gatherMode') as boolean;
    const { daysEbIron, daysRare, totalDays, energyNeeded, runsNeeded } = getAcquisitionPlan(globalTotals, gatherMode);

    // Render Global Totals
    let totalsHtml = '';
    const items = sortMaterials(Object.keys(globalTotals));
    if (items.length === 0) {
      totalsHtml = '<p class="empty-msg">No upgrades planned.</p>';
    } else {
      items.forEach(item => {
        totalsHtml += `<div class="cost-item">
          <span class="cost-name">${item}</span>
          <span class="cost-val">${globalTotals[item].toLocaleString()}</span>
        </div>`;
      });
    }
    totalCostsEl.innerHTML = totalsHtml;

    // Render Per-Skill Totals
    Object.keys(skillTotals).forEach(skillName => {
      const costs = skillTotals[skillName];
      const miniEl = document.querySelector(`.skill-costs-mini[data-skill-id="${skillName}"]`)!;
      if (!miniEl) return;
      const costItems = sortMaterials(Object.keys(costs));
      
      if (costItems.length === 0) {
        miniEl.innerHTML = '';
      } else {
        let html = '<label>Required:</label><div class="mini-grid">';
        costItems.forEach(item => {
          html += `<div class="mini-item"><span>${item}</span> <strong>${costs[item].toLocaleString()}</strong></div>`;
        });
        html += '</div>';
        miniEl.innerHTML = html;
      }
    });

    // Render Time Metrics
    timeMetricsEl.innerHTML = `
      <div class="main-metric">
        <strong>~${totalDays}</strong>
        <span>days total</span>
      </div>
      <div class="sub-metrics">
        <div class="sub-metric"><span>Rare Mats:</span> ~${daysRare}d</div>
        <div class="sub-metric"><span>Ebon Iron:</span> ~${daysEbIron}d</div>
      </div>
    `;

    // Render Efficiency Metrics
    efficiencyMetricsEl.innerHTML = `
      <div class="main-metric">
        <strong>${runsNeeded}</strong>
        <span>outpost reward collections</span>
      </div>
      <div class="sub-metrics">
        <div class="sub-metric"><span>Energy:</span> ${energyNeeded.toLocaleString()}</div>
      </div>
    `;
  };

  state.subscribe(() => {
    updateUI();
  });

  updateInputsFromState();
  updateUI();
</script>

<style lang="scss">
  @use '@/scss/mixins' as *;

  .mystic-tracker {
    padding: 1.5rem;
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .tracker-layout {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  // 1. Summary Panel (Horizontal Stacking)
  :global(.summary-panel) {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
    align-items: stretch;
    @include border($all: true);
    @include background(surface-1);

    :global(.summary-group) {
      padding: 1.25rem;
      
      :global(.group-label) {
        @include font-size(xs);
        @include text-color(muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: bold;
        display: block;
        margin-bottom: 1rem;
        @include border($bottom: true);
        padding-bottom: 0.5rem;
      }
    }
  }

  // Style for the groups within summary
  :global(.costs-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.5rem;

    :global(.cost-item) {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      @include font-size(sm);
      @include border($bottom: true, $style: dashed);
      padding-bottom: 0.25rem;

      :global(.cost-name) {
        @include text-color(muted);
      }
      :global(.cost-val) {
        @include text-color(primary);
        font-weight: bold;
      }
    }

    :global(.empty-msg) {
      @include text-color(muted);
      @include font-size(sm);
      grid-column: 1 / -1;
    }
  }

  :global(.main-metric) {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;

    :global(strong) {
      @include text-color(primary);
      font-size: 2rem; // Emphasize numbers
      line-height: 1;
    }
    :global(span) {
      @include font-size(xs);
      @include text-color(muted);
      text-transform: uppercase;
      font-weight: 500;
    }
  }

  :global(.sub-metrics) {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;

    :global(.sub-metric) {
      @include font-size(sm);
      @include text-color(muted);
      span {
        font-weight: 500;
      }
    }
  }

  :global(.metrics-grid) {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .settings-content {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    gap: 1.5rem;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-weight: 500;
    @include text-color(default);
    user-select: none;
    @include font-size(sm);

    input {
      width: 1.1rem;
      height: 1.1rem;
      accent-color: var(--color-primary);
    }
  }

  // 2. Skill Blocks (Spatial Grouping)
  .blocks-container {
    display: flex;
    flex-direction: column;
    gap: 4rem;
  }

  .skill-block {
    &:not(:last-child) {
      padding-bottom: 4rem;
      @include border($bottom: true);
    }
  }

  // 3. Grid Layout (3 columns above 1080px)
  .skills-grid {
    display: grid;
    gap: 2rem;

    @media (min-width: 1024px) {
      grid-template-columns: repeat(3, 1fr);
    }

    @media (max-width: 1023px) and (min-width: 720px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  // 4. Card Density & Hierarchy
  .skill-info h4 {
    @include font-size(lg);
    @include text-color(primary);
    margin-bottom: 0.5rem;
  }

  // 5. Compressed Upgrade Table
  .upgrade-table {
    display: grid;
    grid-template-columns: 80px 1fr 1fr;
    gap: 0.4rem;
    align-items: center;
    margin-bottom: 1rem;

    .table-header {
      display: contents;
      .col-label {
        @include font-size(xs);
        @include text-color(muted);
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
      }
    }

    .table-row {
      display: contents;
      .row-label {
        @include font-size(xs);
        @include text-color(muted);
        font-weight: 500;
        text-transform: uppercase;
      }

      input {
        width: 100%;
        height: 2.25rem;
        padding: 0 0.75rem;
        @include background(surface-2);
        @include border;
        @include text-color(default);
        text-align: center;
        @include font-size(sm);
        @include font-sans-bold;

        &:focus {
          @include border($color: primary);
          outline: none;
        }
      }
    }
  }

  // 6. Mini Material Lists
  :global(.skill-costs-mini) {
    @include border($top: true, $style: solid);
    padding-top: 0.75rem;

    :global(label) {
      @include font-size(xs);
      @include text-color(muted);
      text-transform: uppercase;
      font-weight: bold;
      display: block;
      margin-bottom: 0.4rem;
    }

    :global(.mini-grid) {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.25rem 0.75rem;
    }

    :global(.mini-item) {
      @include font-size(xs);
      display: flex;
      justify-content: space-between;
      @include text-color(muted);
      
      :global(strong) {
        @include text-color(default);
        @include increase-letter-spacing(-1);
      }
    }
  }

  .info-footer {
    @include text-color(muted);
    opacity: 0.7;
    margin-top: auto;
    p { margin: 0; }
  }
</style>
