---
import Layout from '@/layouts/layout.astro'
import Header from '@/components/generic/header.astro'
import { WEEKLY_CHESTS, MATS_PER_CHEST, SKILL_ORDER } from '@/lib/wwm-constants'

export const meta = {
  icon: 'fa6-solid:scroll',
  title: 'Mystical Insights',
  description: 'Track and plan your Mystic Skill progression across all tiers.',
  type: 'tool',
  linkText: 'Track',
  createdDate: '2026-02-13',
  updatedDate: '2026-02-13',
  draft: false,
}

// Load and Preprocess Data
const skillFiles = import.meta.glob('/src/wwm-data/mystic-skills/*.yaml', { eager: true });

interface SkillData {
  name: string;
  category: string;
  tiers: {
    has_tiers: boolean;
    starting_tier: number;
    starting_rank: number;
    rank_ups: Array<{
      tier: number;
      ranks: Array<{
        rank: number;
        cost: Array<{
          item: string;
          amount: number;
        }>;
      }>;
    }>;
  };
}

const skillsRaw = Object.values(skillFiles)
  .map((m: any) => m.default as SkillData)
  .filter(s => s.tiers?.has_tiers)
  .map(s => {
    // Simplify Ebon Iron names
    const processedTiers = {
      ...s.tiers,
      rank_ups: s.tiers.rank_ups.map(tu => ({
        ...tu,
        ranks: tu.ranks.map(r => ({
          ...r,
          cost: r.cost.map(c => ({
            ...c,
            item: c.item.replace(/Lv\.\s\d+\sEbon Iron/, 'Ebon Iron')
          }))
        }))
      }))
    };
    return { ...s, tiers: processedTiers };
  });

// Flat list for initials
const skillsFlat = [...skillsRaw];

const skillInitials = skillsFlat.map(s => ({
  id: s.name.toLowerCase().replace(/\s+/g, '-'),
  name: s.name,
  minTier: s.tiers.starting_tier,
  maxTier: Math.max(...s.tiers.rank_ups.map(tu => tu.tier)),
  ranksPerTier: s.tiers.rank_ups.reduce((acc, tu) => {
    acc[tu.tier] = tu.ranks.length - 1;
    return acc;
  }, {} as Record<number, number>)
}));

---

<Layout>
  <div class="mystic-tracker">
    <Header
      title="Mystical Insights"
      description="Track and plan your Mystic Skill progression across all tiers."
    />

    <div class="tracker-layout">
      <aside class="sidebar-wrapper">
        <div class="controls card sticky-sidebar">
          <div class="settings-group">
            <h3>Resources Settings</h3>
            <label class="checkbox-container">
              <input type="checkbox" id="gather-mode" checked />
              <span class="checkmark"></span>
              Include Daily Gathering
            </label>
          </div>
          
          <div class="summary-section">
            <h3>Calculated Global Needs</h3>
            <div id="total-costs" class="costs-list">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="acquisition-section">
            <h3>Acquisition Metrics</h3>
            <div id="acquisition-metrics">
               <!-- Populated by JS -->
            </div>
          </div>
          
          <div class="info-footer">
            <p><small>Weekly Chests: {WEEKLY_CHESTS} &times; {MATS_PER_CHEST} mats of choice</small></p>
          </div>
        </div>
      </aside>

      <main class="blocks-container">
        {SKILL_ORDER.map((block, blockIdx) => {
          const blockSkills = block.map(name => skillsRaw.find(s => s.name === name)).filter(Boolean) as SkillData[];
          if (blockSkills.length === 0) return null;

          return (
            <section class="skill-block">
              <div class="block-header">
                <span>Block {blockIdx + 1}</span>
              </div>
              <div class="skills-grid">
                {blockSkills.map(skill => {
                  const id = skill.name.toLowerCase().replace(/\s+/g, '-');
                  const maxTier = Math.max(...skill.tiers.rank_ups.map(tu => tu.tier));
                  
                  return (
                    <div class="skill-entry card" data-skill-name={skill.name}>
                      <div class="skill-info">
                        <h4>{skill.name}</h4>
                      </div>
                      
                      <div class="skill-content">
                        <div class="upgrade-table">
                          <div class="table-header">
                            <span></span>
                            <span class="col-label">Tier</span>
                            <span class="col-label">Rank</span>
                          </div>
                          <div class="table-row">
                            <span class="row-label">Current</span>
                            <input type="number" class="cur-tier" data-id={id} min={skill.tiers.starting_tier} max={maxTier} value={skill.tiers.starting_tier} />
                            <input type="number" class="cur-rank" data-id={id} min="0" value="0" />
                          </div>
                          <div class="table-row">
                            <span class="row-label">Target</span>
                            <input type="number" class="target-tier" data-id={id} min={skill.tiers.starting_tier} max={maxTier} value={skill.tiers.starting_tier} />
                            <input type="number" class="target-rank" data-id={id} min="0" value="0" />
                          </div>
                        </div>

                        <div class="skill-costs-mini" data-skill-id={skill.name}>
                          <!-- Populated by JS -->
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
          );
        })}
      </main>
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ skillsInitialData: skillInitials, fullSkillsData: skillsRaw }}>
  window.MYSTIC_SKILLS_DATA = fullSkillsData;
  window.MYSTIC_SKILLS_INITIALS = skillsInitialData;
</script>

<script>
  import { StateManager } from '@/lib/state-manager'
  import { EB_IRON_PER_OUTPOST, ENERGY_PER_OUTPOST } from '@/lib/wwm-constants'
  import { calculateTotals, getAcquisitionPlan, sortMaterials } from './logic'

  const skills = (window as any).MYSTIC_SKILLS_DATA;
  const skillsInitials = (window as any).MYSTIC_SKILLS_INITIALS;

  const initialValues = new Map<string, any>();
  initialValues.set('gatherMode', true);
  
  skillsInitials.forEach((s: any) => {
    initialValues.set(`${s.id}-curTier`, s.minTier);
    initialValues.set(`${s.id}-curRank`, 0);
    initialValues.set(`${s.id}-targetTier`, s.minTier);
    initialValues.set(`${s.id}-targetRank`, 0);
  });

  const state = new StateManager(initialValues, 'mystic-skills-state');

  const gatherCheckbox = document.querySelector('#gather-mode') as HTMLInputElement;
  const totalCostsEl = document.querySelector('#total-costs')!;
  const metricsEl = document.querySelector('#acquisition-metrics')!;

  const curTierInputs = document.querySelectorAll('.cur-tier') as NodeListOf<HTMLInputElement>;
  const curRankInputs = document.querySelectorAll('.cur-rank') as NodeListOf<HTMLInputElement>;
  const targetTierInputs = document.querySelectorAll('.target-tier') as NodeListOf<HTMLInputElement>;
  const targetRankInputs = document.querySelectorAll('.target-rank') as NodeListOf<HTMLInputElement>;

  const updateInputsFromState = () => {
    gatherCheckbox.checked = state.get('gatherMode') as boolean;
    
    const setInputValue = (inputs: NodeListOf<HTMLInputElement>, suffix: string) => {
      inputs.forEach(input => {
        const id = input.dataset.id!;
        const val = state.get<number | string | boolean>(`${id}-${suffix}`);
        input.value = val !== undefined ? val.toString() : '';
        
        if (suffix.includes('Tier')) {
          const tier = parseInt(input.value);
          const skill = skillsInitials.find((si: any) => si.id === id);
          const maxRank = skill.ranksPerTier[tier] || 0;
          const rankInputSelector = suffix.startsWith('cur') ? `.cur-rank[data-id="${id}"]` : `.target-rank[data-id="${id}"]`;
          const rankInput = document.querySelector(rankInputSelector) as HTMLInputElement;
          if (rankInput) {
            rankInput.max = maxRank.toString();
            if (parseInt(rankInput.value) > maxRank) {
              rankInput.value = maxRank.toString();
              state.set(`${id}-${suffix.replace('Tier', 'Rank')}`, maxRank);
            }
          }
        }
      });
    };

    setInputValue(curTierInputs, 'curTier');
    setInputValue(curRankInputs, 'curRank');
    setInputValue(targetTierInputs, 'targetTier');
    setInputValue(targetRankInputs, 'targetRank');
  };

  gatherCheckbox.addEventListener('change', () => state.set('gatherMode', gatherCheckbox.checked));

  const addInputListener = (inputs: NodeListOf<HTMLInputElement>, suffix: string) => {
    inputs.forEach(input => {
      input.addEventListener('change', () => {
        const id = input.dataset.id!;
        let val = parseInt(input.value) || 0;
        const min = parseInt(input.min) || 0;
        const max = parseInt(input.max) || 999;
        if (val < min) val = min;
        if (val > max) val = max;
        input.value = val.toString();
        state.set(`${id}-${suffix}`, val);
        updateInputsFromState();
      });
    });
  };

  addInputListener(curTierInputs, 'curTier');
  addInputListener(curRankInputs, 'curRank');
  addInputListener(targetTierInputs, 'targetTier');
  addInputListener(targetRankInputs, 'targetRank');

  const updateUI = () => {
    const { skillTotals, globalTotals } = calculateTotals(skills, state.getState());
    const gatherMode = state.get('gatherMode') as boolean;
    const { daysEbIron, daysRare, totalDays, energyNeeded, runsNeeded } = getAcquisitionPlan(globalTotals, gatherMode);

    // Render Global Totals
    let totalsHtml = '';
    const items = sortMaterials(Object.keys(globalTotals));
    if (items.length === 0) {
      totalsHtml = '<p class="empty-msg">No upgrades planned.</p>';
    } else {
      items.forEach(item => {
        totalsHtml += `<div class="cost-item">
          <span class="cost-name">${item}</span>
          <span class="cost-val">${globalTotals[item].toLocaleString()}</span>
        </div>`;
      });
    }
    totalCostsEl.innerHTML = totalsHtml;

    // Render Per-Skill Totals
    Object.keys(skillTotals).forEach(skillName => {
      const costs = skillTotals[skillName];
      const miniEl = document.querySelector(`.skill-costs-mini[data-skill-id="${skillName}"]`)!;
      const costItems = sortMaterials(Object.keys(costs));
      
      if (costItems.length === 0) {
        miniEl.innerHTML = '';
      } else {
        let html = '<label>Required:</label><div class="mini-grid">';
        costItems.forEach(item => {
          html += `<div class="mini-item"><span>${item}:</span> <strong>${costs[item].toLocaleString()}</strong></div>`;
        });
        html += '</div>';
        miniEl.innerHTML = html;
      }
    });

    // Render Metrics
    let metricsHtml = `
      <div class="metric-group">
        <label>Time Estimation</label>
        <div class="metric-row">
          <span>Overall Time</span>
          <strong>~${totalDays} days</strong>
        </div>
        <div class="metric-row sub-metric">
          <span>Rare Mats</span>
          <span>~${daysRare} days</span>
        </div>
        <div class="metric-row sub-metric">
          <span>Ebon Iron</span>
          <span>~${daysEbIron} days</span>
        </div>
      </div>

      <div class="metric-group">
        <label>Outpost Efficiency</label>
        <div class="metric-row">
          <span>Runs Needed</span>
          <strong>${runsNeeded}</strong>
        </div>
        <div class="metric-row">
          <span>Energy Cost</span>
          <strong>${energyNeeded}</strong>
        </div>
      </div>
    `;

    metricsEl.innerHTML = metricsHtml;
  };

  state.subscribe(() => {
    updateUI();
  });

  updateInputsFromState();
  updateUI();
</script>

<style lang="scss">
  @use '@/scss/mixins' as *;

  .mystic-tracker {
    padding: 1.5rem;
    max-width: 1300px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .tracker-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 2rem;
    align-items: flex-start;

    @media (max-width: 1000px) {
      grid-template-columns: 1fr;
    }
  }

  .card {
    @include background(surface-1);
    @include border($all: true);
    @include shadow-elevation(md);
    border-radius: 0; // Removed border radii
    overflow: hidden;
  }

  .sidebar-wrapper {
    @media (min-width: 1001px) {
      height: 100%;
    }
  }

  .sticky-sidebar {
    position: sticky;
    top: 2rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;

    h3 {
      @include font-size(sm);
      @include text-color(muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      @include border($bottom: true);
      padding-bottom: 0.5rem;
    }
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-weight: 500;
    @include text-color(default);
    user-select: none;
    @include font-size(sm);

    input {
      width: 1.2rem;
      height: 1.2rem;
      accent-color: var(--color-primary);
      border-radius: 0;
    }
  }

  .costs-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;

    .empty-msg {
      @include text-color(muted);
      @include font-size(sm);
      font-style: italic;
    }

    .cost-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      @include background(surface-2);
      border-radius: 0;
      @include font-size(sm);

      .cost-name {
        @include text-color(default);
        font-weight: 500;
      }
      .cost-val {
        @include text-color(primary);
        font-family: monospace;
        font-weight: bold;
      }
    }
  }

  .metric-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;

    label {
      @include font-size(sm);
      @include text-color(muted);
      font-weight: bold;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      @include font-size(sm);

      strong {
        @include text-color(primary);
      }

      &.sub-metric {
        margin-left: 0.5rem;
        @include font-size(sm);
        @include text-color(muted);
      }
    }
  }

  .blocks-container {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .skill-block {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;

    .block-header {
      @include border($bottom: true);
      padding-bottom: 0.5rem;
      
      span {
        @include font-size(sm);
        @include text-color(muted);
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 0.1em;
      }
    }
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 1.5rem;
  }

  .skill-entry {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;

    .skill-info {
      h4 {
        margin: 0;
        @include font-size(lg);
        @include text-color(primary);
      }
    }
  }

  .skill-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .upgrade-table {
    display: grid;
    grid-template-columns: 80px 1fr 1fr;
    gap: 0.5rem;
    align-items: center;

    .table-header {
      display: contents;
      .col-label {
        @include font-size(sm);
        @include text-color(muted);
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
    }

    .table-row {
      display: contents;
      .row-label {
        @include font-size(sm);
        @include text-color(muted);
        font-weight: 500;
      }

      input {
        width: 100%;
        height: 2.2rem;
        @include background(surface-2);
        @include border;
        border-radius: 0;
        text-align: center;
        @include text-color(default);
        @include font-size(sm);
        font-weight: 600;

        &:focus {
          @include border($color: primary);
          outline: none;
        }
      }
    }
  }

  .skill-costs-mini {
    @include border($top: true);
    padding-top: 1rem;

    label {
      @include font-size(sm);
      @include text-color(muted);
      text-transform: uppercase;
      font-weight: bold;
      display: block;
      margin-bottom: 0.5rem;
    }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.4rem;
    }

    .mini-item {
      @include font-size(sm);
      @include text-color(default);
      span {
        @include text-color(muted);
      }
      strong {
        @include text-color(primary);
      }
    }
  }

  .info-footer {
    @include border($top: true);
    padding-top: 1rem;
    @include text-color(muted);
    text-align: center;
  }
</style>
